<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Admin – Car Loan Submissions</title>

  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      margin-bottom: 8px;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    button {
      padding: 8px 12px;
      cursor: pointer;
    }

    .status {
      font-size: 12px;
      color: #555;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid #ddd;
      margin-top: 12px;
    }

    table {
      border-collapse: collapse;
      min-width: 1800px; /* force horizontal scroll */
      width: 100%;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 12px;
      white-space: nowrap;
      text-align: left;
    }

    th {
      background: #f4f4f4;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    a {
      color: #0b5fff;
      cursor: pointer;
      text-decoration: underline;
    }

    .muted {
      color: #888;
    }
  </style>
</head>
<body>

<h1>Admin – Car Loan Submissions</h1>

<div class="controls">
  <button id="setKeyBtn">Set admin key</button>
  <button id="refreshBtn">Refresh</button>
  <button id="approveBtn">Approve selected</button>
  <span id="status" class="status"></span>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>

        <th>ID</th>
        <th>Status</th>
        <th>Submitted</th>

        <th>Lender</th>
        <th>Interest %</th>

        <th>State</th>
        <th>Channel</th>

        <th>Income band</th>
        <th>Employment</th>
        <th>Age band</th>

        <th>Housing</th>
        <th>Rent band</th>
        <th>Mortgage band</th>

        <th>Dependents</th>
        <th>Debt band</th>
        <th>Assets band</th>

        <th>Loan amount</th>
        <th>Purpose</th>
        <th>Term (mo)</th>
        <th>Guarantor</th>
        <th>Deposit %</th>
        <th>Vehicle age</th>

        <th>Evidence</th>
      </tr>
    </thead>

    <tbody id="rows"></tbody>
  </table>
</div>

<script>
  const KEY_STORAGE = "RR_ADMIN_KEY";

  function getKey() {
    return sessionStorage.getItem(KEY_STORAGE) || "";
  }

  function setKey() {
    const k = prompt("Paste ADMIN_KEY (stored for this tab only):", getKey());
    if (k && k.length > 5) {
      sessionStorage.setItem(KEY_STORAGE, k.trim());
      setStatus("Admin key set.");
    } else {
      setStatus("No key set.");
    }
  }

  function setStatus(msg) {
    document.getElementById("status").textContent = msg || "";
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function apiFetch(url, opts = {}) {
    const key = getKey();
    if (!key) throw new Error("Admin key not set");

    return fetch(url, {
      ...opts,
      headers: {
        ...(opts.headers || {}),
        "x-admin-key": key
      }
    });
  }

function openEvidence(objectKey) {
  const key = getKey();
  if (!key) {
    alert("Admin key not set");
    return;
  }

  // Open the PDF stream directly in a new tab
  const url =
    `/api/admin/evidence?key=${encodeURIComponent(objectKey)}`;

  window.open(url, "_blank", "noopener");
}
  }

  async function loadPending() {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    const res = await apiFetch("/api/admin/unverifiedcarloan?status=pending");
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    for (const r of (data.rows || [])) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><input type="checkbox" class="rowCheck" data-id="${r.id}"></td>

        <td>${r.id}</td>
        <td>${r.status}</td>
        <td>${r.submitted_at}</td>

        <td>${escapeHtml(r.lender)}</td>
        <td>${r.interest_rate}</td>

        <td>${r.state}</td>
        <td>${r.application_channel}</td>

        <td>${r.income_band}</td>
        <td>${r.employment_status}</td>
        <td>${r.age_band}</td>

        <td>${r.housing_status}</td>
        <td>${r.rent_payment_band || "—"}</td>
        <td>${r.mortgage_payment_band || "—"}</td>

        <td>${r.dependents}</td>
        <td>${r.monthly_debt_repayments_band}</td>
        <td>${r.liquid_assets_band}</td>

        <td>${r.loan_amount_band}</td>
        <td>${r.loan_purpose}</td>
        <td>${r.loan_term_months}</td>
        <td>${r.guarantor}</td>
        <td>${r.deposit_percent_band}</td>
        <td>${r.vehicle_age_band}</td>

        <td>
          ${r.evidence_pdf_key
            ? `<a data-key="${escapeHtml(r.evidence_pdf_key)}" class="evidenceLink">View PDF</a>`
            : `<span class="muted">—</span>`}
        </td>
      `;

      tbody.appendChild(tr);
    }

    document.querySelectorAll(".evidenceLink").forEach(a => {
      a.addEventListener("click", e => {
        e.preventDefault();
        openEvidence(e.target.dataset.key);
      });
    });

    setStatus(`Loaded ${data.rows?.length || 0} pending rows`);
  }

  function selectedIds() {
    return Array.from(document.querySelectorAll(".rowCheck:checked"))
      .map(cb => Number(cb.dataset.id))
      .filter(n => n > 0);
  }

  async function approveSelected() {
    const ids = selectedIds();
    if (!ids.length) return setStatus("Nothing selected");

    if (!confirm(`Approve ${ids.length} submissions?`)) return;

    const res = await apiFetch("/api/admin/approvecarloan", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ ids, approvedBy: "callum" })
    });

    if (!res.ok) throw new Error(await res.text());
    await loadPending();
  }

  document.getElementById("setKeyBtn").onclick = setKey;
  document.getElementById("refreshBtn").onclick = loadPending;
  document.getElementById("approveBtn").onclick = approveSelected;

  document.getElementById("selectAll").addEventListener("change", e => {
    document.querySelectorAll(".rowCheck").forEach(cb => cb.checked = e.target.checked);
  });

  (async () => {
    try {
      if (!getKey()) setKey();
      await loadPending();
    } catch (err) {
      console.error(err);
      setStatus(err.message);
    }
  })();
</script>

</body>
</html>
