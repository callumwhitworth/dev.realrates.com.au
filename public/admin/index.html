<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Admin – Car Loans</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f6f6f6; }
    .row { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap: wrap; }
    button { padding: 8px 12px; cursor: pointer; }
    .muted { color:#666; font-size: 12px; }
    .section { margin-top: 22px; padding-top: 18px; border-top: 1px solid #eee; }
  </style>
</head>
<body>
  <h1>Admin – Car Loans</h1>

  <div class="row">
    <button id="setKeyBtn">Set admin key</button>
    <button id="refreshBtn">Refresh</button>
    <button id="approveBtn">Approve selected</button>
    <span id="status" class="muted"></span>
  </div>

  <h2>Pending approvals</h2>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" /></th>
        <th>ID</th>
        <th>Amount band</th>
        <th>Lender</th>
        <th>Rate (%)</th>
        <th>Submitted</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="section">
    <h2>Recently approved (production car_loans)</h2>
    <div class="muted">This is your visual queue that the approval copy finished.</div>

    <table>
      <thead>
        <tr>
          <th>Prod ID</th>
          <th>Source unverified ID</th>
          <th>Amount band</th>
          <th>Lender</th>
          <th>Rate (%)</th>
          <th>Verified</th>
        </tr>
      </thead>
      <tbody id="approvedRows"></tbody>
    </table>
  </div>

<script>
  const KEY_STORAGE = "RR_ADMIN_KEY";

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  function getKey() {
    return sessionStorage.getItem(KEY_STORAGE) || "";
  }

  function setKey() {
    const k = prompt("Paste ADMIN_KEY (stored for this tab session only):", getKey());
    if (k && k.trim().length > 5) {
      sessionStorage.setItem(KEY_STORAGE, k.trim());
      setStatus("Admin key set for this session.");
    } else {
      setStatus("No key set.");
    }
  }

  function setStatus(msg) {
    document.getElementById("status").textContent = msg || "";
  }

  async function apiFetch(url, opts = {}) {
    const key = getKey();
    if (!key) throw new Error("No admin key set. Click 'Set admin key'.");

    const headers = Object.assign({}, opts.headers || {}, {
      "x-admin-key": key
    });

    return fetch(url, Object.assign({}, opts, { headers }));
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function loadPending() {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    const res = await apiFetch("/api/admin/unverifiedcarloan?status=pending");
    if (!res.ok) throw new Error(`Load pending failed (${res.status}): ${await res.text()}`);
    const data = await res.json();

    for (const r of (data.rows || [])) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="rowCheck" data-id="${r.id}"></td>
        <td>${r.id}</td>
        <td>${r.loan_amount_band}</td>
        <td>${escapeHtml(r.lender)}</td>
        <td>${r.interest_rate}</td>
        <td>${r.submitted_at}</td>
        <td>${r.status}</td>
      `;
      tbody.appendChild(tr);
    }

    return data.rows?.length || 0;
  }

  async function loadApproved() {
    const tbody = document.getElementById("approvedRows");
    tbody.innerHTML = "";

    const res = await apiFetch("/api/admin/carloans?limit=20");
    if (!res.ok) throw new Error(`Load approved failed (${res.status}): ${await res.text()}`);
    const data = await res.json();

    for (const r of (data.rows || [])) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.source_unverified_id}</td>
        <td>${r.loan_amount_band}</td>
        <td>${escapeHtml(r.lender)}</td>
        <td>${r.interest_rate}</td>
        <td>${r.verified_at}</td>
      `;
      tbody.appendChild(tr);
    }

    return data.rows?.length || 0;
  }

  function selectedIds() {
    return Array.from(document.querySelectorAll(".rowCheck:checked"))
      .map(x => Number(x.dataset.id))
      .filter(n => Number.isInteger(n) && n > 0);
  }

  async function approveSelected() {
    const ids = selectedIds();
    if (ids.length === 0) { setStatus("Nothing selected."); return; }
    if (!confirm(`Approve ${ids.length} submissions?`)) return;

    setStatus("Approving...");
    const res = await apiFetch("/api/admin/approvecarloan", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ ids, approvedBy: "callum" })
    });

    if (!res.ok) throw new Error(`Approve failed (${res.status}): ${await res.text()}`);

    setStatus("Approved. Waiting 1s then refreshing...");
    await sleep(1000);

    const [pendingCount, approvedCount] = await Promise.all([loadPending(), loadApproved()]);
    setStatus(`Pending: ${pendingCount} | Recent approved: ${approvedCount}`);
  }

  async function refreshAll() {
    setStatus("Refreshing...");
    const [pendingCount, approvedCount] = await Promise.all([loadPending(), loadApproved()]);
    setStatus(`Pending: ${pendingCount} | Recent approved: ${approvedCount}`);
  }

  document.getElementById("setKeyBtn").addEventListener("click", setKey);
  document.getElementById("refreshBtn").addEventListener("click", refreshAll);
  document.getElementById("approveBtn").addEventListener("click", approveSelected);

  document.getElementById("selectAll").addEventListener("change", (e) => {
    document.querySelectorAll(".rowCheck").forEach(cb => cb.checked = e.target.checked);
  });

  (async () => {
    try {
      if (!getKey()) setKey();
      await refreshAll();
    } catch (err) {
      console.error(err);
      setStatus(err.message || "Error");
    }
  })();
</script>
</body>
</html>
